<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Word Adventure!</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Chalkboard SE','Comic Sans MS','Fredoka',cursive,sans-serif;min-height:100vh;overflow-x:hidden;background:#1a1a2e;color:#fff;-webkit-user-select:none;user-select:none}
#app{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;position:relative}

/* ===== WELCOME SCREEN ===== */
.welcome{text-align:center;animation:fadeIn .5s ease}
.welcome h1{font-size:3.5rem;margin-bottom:10px;text-shadow:3px 3px 0 rgba(0,0,0,.2)}
.welcome .mascot{font-size:5rem;display:block;margin:10px auto;animation:bounce 2s infinite}
.welcome .subtitle{font-size:1.3rem;margin-bottom:30px;opacity:.9}
.grade-grid{display:flex;flex-direction:column;gap:14px;width:100%;max-width:400px;margin:0 auto}
.grade-btn{padding:18px 30px;border:none;border-radius:20px;font-size:1.5rem;font-family:inherit;cursor:pointer;color:#fff;font-weight:bold;text-shadow:1px 1px 0 rgba(0,0,0,.2);transition:transform .15s,box-shadow .15s;box-shadow:0 6px 0 rgba(0,0,0,.2),0 8px 20px rgba(0,0,0,.3)}
.grade-btn:hover{transform:translateY(-2px);box-shadow:0 8px 0 rgba(0,0,0,.2),0 12px 24px rgba(0,0,0,.3)}
.grade-btn:active{transform:translateY(2px);box-shadow:0 2px 0 rgba(0,0,0,.2),0 4px 10px rgba(0,0,0,.3)}
.grade-btn.kinder{background:linear-gradient(135deg,#e74c3c,#c0392b)}
.grade-btn.g1{background:linear-gradient(135deg,#f39c12,#e67e22)}
.grade-btn.g2{background:linear-gradient(135deg,#27ae60,#219a52)}
.grade-btn.g3{background:linear-gradient(135deg,#3498db,#2980b9)}
.grade-btn.g4{background:linear-gradient(135deg,#9b59b6,#8e44ad)}
.word-count{font-size:.85rem;opacity:.8;font-weight:normal}

/* ===== SETTINGS ===== */
.settings-btn{position:absolute;top:15px;right:15px;background:rgba(255,255,255,.12);border:none;border-radius:50%;width:44px;height:44px;font-size:1.4rem;cursor:pointer;transition:transform .15s,background .15s;color:#fff}
.settings-btn:hover{background:rgba(255,255,255,.2);transform:rotate(30deg)}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:2000;display:flex;align-items:center;justify-content:center;padding:20px;animation:fadeIn .2s ease}
.modal{background:#2c2c54;border-radius:20px;padding:30px;max-width:420px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.modal h3{font-size:1.5rem;margin-bottom:15px;text-align:center}
.modal label{display:block;font-size:1rem;margin-bottom:6px;opacity:.9}
.modal input{width:100%;padding:12px 14px;border:2px solid rgba(255,255,255,.2);border-radius:12px;background:rgba(255,255,255,.08);color:#fff;font-size:1rem;font-family:inherit;outline:none;transition:border-color .2s}
.modal input:focus{border-color:rgba(255,255,255,.5)}
.modal .hint{font-size:.8rem;opacity:.6;margin-top:6px;line-height:1.4}
.modal .api-status{margin-top:10px;padding:8px 12px;border-radius:8px;font-size:.9rem;text-align:center}
.modal .api-status.connected{background:rgba(46,204,113,.2);color:#2ecc71}
.modal .api-status.none{background:rgba(241,196,15,.15);color:#f1c40f}
.modal-buttons{display:flex;gap:10px;margin-top:20px}
.modal-buttons button{flex:1;padding:12px;border:none;border-radius:12px;font-size:1.1rem;font-family:inherit;font-weight:bold;cursor:pointer;color:#fff;transition:transform .1s}
.modal-buttons button:active{transform:scale(.97)}
.btn-save{background:linear-gradient(135deg,#2ecc71,#27ae60)}
.btn-cancel{background:rgba(255,255,255,.15)}

/* ===== QUIZ SCREEN ===== */
.quiz{width:100%;max-width:500px;animation:fadeIn .3s ease}
.quiz-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding:0 5px}
.score-display{font-size:1.3rem;font-weight:bold}
.score-display .pts{color:#f1c40f}
.progress-display{font-size:1.1rem;opacity:.9}
.progress-bar{width:100%;height:12px;background:rgba(255,255,255,.15);border-radius:10px;margin-bottom:20px;overflow:hidden}
.progress-fill{height:100%;border-radius:10px;transition:width .4s ease;background:linear-gradient(90deg,#f1c40f,#e67e22)}

.emoji-area{text-align:center;margin-bottom:5px}
.emoji-big{font-size:6rem;display:block;animation:popIn .4s ease}
.prompt-text{font-size:1.4rem;margin:10px 0 5px;font-weight:bold}
.target-word-display{font-size:1.8rem;color:#f1c40f;font-weight:bold;margin-bottom:15px}
.speaker-btn{background:rgba(255,255,255,.15);border:2px solid rgba(255,255,255,.3);border-radius:50%;width:50px;height:50px;font-size:1.5rem;cursor:pointer;margin:8px auto;display:block;transition:transform .15s,background .15s}
.speaker-btn:hover{background:rgba(255,255,255,.25);transform:scale(1.1)}

.options-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:15px}
.option-btn{padding:22px 15px;border:3px solid rgba(255,255,255,.25);border-radius:18px;font-size:1.7rem;font-family:inherit;cursor:pointer;background:rgba(255,255,255,.08);color:#fff;font-weight:bold;transition:transform .1s,border-color .2s,background .2s;text-align:center;min-height:70px;display:flex;align-items:center;justify-content:center;gap:10px}
.option-btn:hover{background:rgba(255,255,255,.15);border-color:rgba(255,255,255,.4);transform:scale(1.03)}
.option-btn:active{transform:scale(.97)}
.option-btn.correct{background:rgba(46,204,113,.4)!important;border-color:#2ecc71!important;animation:correctPulse .5s ease}
.option-btn.wrong{background:rgba(231,76,60,.3)!important;border-color:#e74c3c!important;animation:wrongShake .4s ease}
.option-btn.reveal{background:rgba(46,204,113,.2)!important;border-color:#2ecc71!important}
.option-btn.disabled{pointer-events:none;opacity:.7}

.feedback{text-align:center;margin-top:15px;font-size:1.4rem;font-weight:bold;min-height:45px;display:flex;align-items:center;justify-content:center}
.feedback.correct-fb{color:#2ecc71;animation:fadeIn .3s}
.feedback.wrong-fb{color:#e74c3c;animation:fadeIn .3s}
.next-btn{margin-top:15px;padding:16px 40px;border:none;border-radius:16px;font-size:1.3rem;font-family:inherit;font-weight:bold;cursor:pointer;color:#fff;background:linear-gradient(135deg,#3498db,#2980b9);box-shadow:0 4px 0 rgba(0,0,0,.2);transition:transform .1s;display:block;margin-left:auto;margin-right:auto}
.next-btn:hover{transform:translateY(-2px)}
.next-btn:active{transform:translateY(2px);box-shadow:0 1px 0 rgba(0,0,0,.2)}

/* ===== RESULTS SCREEN ===== */
.results{text-align:center;width:100%;max-width:500px;animation:fadeIn .5s ease}
.results h2{font-size:2.5rem;margin-bottom:5px}
.stars-area{font-size:4rem;margin:10px 0}
.score-final{font-size:1.5rem;margin-bottom:20px;opacity:.9}
.review-section{text-align:left;margin:20px 0}
.review-section h3{font-size:1.3rem;margin-bottom:12px;text-align:center}
.review-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.review-card{display:flex;align-items:center;gap:10px;padding:10px 14px;background:rgba(255,255,255,.08);border-radius:12px;border-left:4px solid #2ecc71}
.review-card.missed{border-left-color:#e74c3c}
.review-card .r-emoji{font-size:1.8rem}
.review-card .r-word{font-size:1.2rem;font-weight:bold}
.review-card .r-check{margin-left:auto;font-size:1.2rem}
.results-buttons{display:flex;gap:12px;justify-content:center;margin-top:25px;flex-wrap:wrap}
.results-buttons button{padding:14px 28px;border:none;border-radius:14px;font-size:1.2rem;font-family:inherit;font-weight:bold;cursor:pointer;color:#fff;box-shadow:0 4px 0 rgba(0,0,0,.2);transition:transform .1s}
.results-buttons button:active{transform:translateY(2px)}
.btn-replay{background:linear-gradient(135deg,#2ecc71,#27ae60)}
.btn-home{background:linear-gradient(135deg,#95a5a6,#7f8c8d)}

/* ===== CONFETTI CANVAS ===== */
#confetti-canvas{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:1000}

/* ===== ANIMATIONS ===== */
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-15px)}}
@keyframes popIn{0%{transform:scale(0);opacity:0}50%{transform:scale(1.2)}100%{transform:scale(1);opacity:1}}
@keyframes correctPulse{0%{transform:scale(1)}50%{transform:scale(1.08)}100%{transform:scale(1)}}
@keyframes wrongShake{0%,100%{transform:translateX(0)}20%{transform:translateX(-10px)}40%{transform:translateX(10px)}60%{transform:translateX(-6px)}80%{transform:translateX(6px)}}
@keyframes starPop{0%{transform:scale(0) rotate(0deg)}60%{transform:scale(1.3) rotate(10deg)}100%{transform:scale(1) rotate(0deg)}}
.star-anim{display:inline-block;animation:starPop .5s ease forwards;opacity:0}
.star-anim:nth-child(1){animation-delay:.1s}
.star-anim:nth-child(2){animation-delay:.3s}
.star-anim:nth-child(3){animation-delay:.5s}

/* ===== GRADE THEME BACKGROUNDS ===== */
.theme-kinder{background:linear-gradient(135deg,#1a1a2e,#3d1a1a)}
.theme-g1{background:linear-gradient(135deg,#1a1a2e,#3d2e1a)}
.theme-g2{background:linear-gradient(135deg,#1a1a2e,#1a3d22)}
.theme-g3{background:linear-gradient(135deg,#1a1a2e,#1a2a3d)}
.theme-g4{background:linear-gradient(135deg,#1a1a2e,#2d1a3d)}

/* ===== RESPONSIVE ===== */
@media(max-width:500px){
  .welcome h1{font-size:2.5rem}
  .emoji-big{font-size:4.5rem}
  .option-btn{font-size:1.4rem;padding:18px 10px}
  .prompt-text{font-size:1.2rem}
  .target-word-display{font-size:1.5rem}
}
@media(min-width:768px){
  .options-grid{max-width:450px;margin-left:auto;margin-right:auto}
}
</style>
</head>
<body>
<div id="app"></div>
<canvas id="confetti-canvas"></canvas>

<script>
// ===================== WORD DATA =====================
const GRADES = {
  kindergarten: {
    name: "Kindergarten",
    btnClass: "kinder",
    themeClass: "theme-kinder",
    words: [
      ["a","üÖ∞Ô∏è"],["about","üí≠"],["all","üåé"],["am","üôã"],["an","üìù"],
      ["and","ü§ù"],["apple","üçé"],["are","üë•"],["as","‚û°Ô∏è"],["at","üìç"],
      ["baby","üë∂"],["be","üêù"],["bed","üõèÔ∏è"],["been","‚úÖ"],["bell","üîî"],
      ["but","‚úã"],["by","üëã"],["bye","üëã"],["called","üìû"],["can","üí™"],
      ["cat","üê±"],["come","ü´≥"],["could","ü§î"],["day","‚òÄÔ∏è"],["did","‚úÖ"],
      ["do","üí™"],["doll","üß∏"],["down","‚¨áÔ∏è"],["drink","ü•§"],["duck","ü¶Ü"],
      ["each","‚òùÔ∏è"],["egg","ü•ö"],["find","üîç"],["first","ü•á"],["for","üéÅ"],
      ["from","üì§"],["get","üéØ"],["go","üèÉ"],["going","üö∂"],["had","üì¶"],
      ["has","üéí"],["have","ü§≤"],["he","üë¶"],["her","üëß"],["hill","‚õ∞Ô∏è"],
      ["him","üë¶"],["his","üë§"],["how","‚ùì"],["I","üôã"],["if","ü§∑"],
      ["in","üì•"],["into","üì•"],["is","‚ú®"],["it","üëâ"],["its","üè∑Ô∏è"],
      ["jump","ü¶ò"],["leg","ü¶µ"],["like","‚ù§Ô∏è"],["long","üìè"],["look","üëÄ"],
      ["made","üèóÔ∏è"],["make","üî®"],["many","üë®‚Äçüë©‚Äçüëß‚Äçüë¶"],["may","üå∏"],["more","‚ûï"],
      ["my","üíù"],["no","üö´"],["not","‚ùå"],["now","‚è∞"],["number","üî¢"],
      ["of","üìé"],["on","üîõ"],["one","1Ô∏è‚É£"],["or","‚ÜîÔ∏è"],["other","üëâ"],
      ["out","üö™"],["part","üß©"],["people","üë•"],["pick","‚úã"],["pig","üê∑"],
      ["ring","üíç"],["said","üí¨"],["see","üëÅÔ∏è"],["she","üë©"],["sit","ü™ë"],
      ["sleep","üò¥"],["so","üí´"],["some","üîµ"],["than","‚öñÔ∏è"],["that","üëÜ"],
      ["the","üìå"],["their","üë®‚Äçüë©‚Äçüëß"],["them","üë´"],["then","‚è≠Ô∏è"],["there","üìç"],
      ["these","üëá"],["they","üë•"],["this","üëà"],["time","‚è∞"],["to","‚û°Ô∏è"],
      ["two","‚úåÔ∏è"],["up","‚¨ÜÔ∏è"],["use","üîß"],["was","üìÖ"],["water","üíß"],
      ["way","üõ§Ô∏è"],["we","üë´"],["were","üìÖ"],["what","‚ùì"],["when","üïê"],
      ["which","ü§î"],["who","üïµÔ∏è"],["will","üí™"],["with","ü§ù"],["words","üìñ"],
      ["would","üí≠"],["write","‚úèÔ∏è"],["yellow","üíõ"],["you","ü´µ"],["your","üéí"]
    ]
  },
  grade1: {
    name: "Grade 1",
    btnClass: "g1",
    themeClass: "theme-g1",
    words: [
      ["after","‚è∞"],["again","üîÑ"],["air","üí®"],["also","‚ûï"],["animal","üêæ"],
      ["another","üîÅ"],["answer","üí°"],["any","üåü"],["around","üîÑ"],["ask","‚ùì"],
      ["away","üèÉ"],["back","üîô"],["bear","üêª"],["because","üí°"],["before","‚è™"],
      ["big","üêò"],["bird","üê¶"],["blue","üíô"],["boy","üë¶"],["brown","üü§"],
      ["cake","üéÇ"],["came","üö∂"],["car","üöó"],["change","üîÑ"],["coat","üß•"],
      ["corn","üåΩ"],["cow","üêÑ"],["different","üîÄ"],["does","ü§∑"],["don't","üö´"],
      ["end","üèÅ"],["even","‚öñÔ∏è"],["flower","üå∏"],["follow","üë£"],["form","üìã"],
      ["found","üîç"],["girl","üëß"],["give","üéÅ"],["goes","üö∂"],["gone","üí®"],
      ["good","üëç"],["grass","üå±"],["great","‚≠ê"],["hand","‚úã"],["happy","üòä"],
      ["help","üÜò"],["here","üìç"],["home","üè†"],["house","üè°"],["just","‚òùÔ∏è"],
      ["kind","üíù"],["know","üß†"],["land","üèùÔ∏è"],["large","üêã"],["learn","üìö"],
      ["letter","‚úâÔ∏è"],["line","‚ûñ"],["little","üêú"],["live","üè†"],["man","üë®"],
      ["me","üôã"],["means","üí≠"],["men","üë®‚Äçüë®‚Äçüë¶"],["moon","üåô"],["most","üèÜ"],
      ["move","üèÉ"],["much","üåä"],["must","‚ö°"],["name","üìõ"],["need","üôè"],
      ["nest","ü™∫"],["new","‚ú®"],["nine","9Ô∏è‚É£"],["off","üì¥"],["old","üë¥"],
      ["only","‚òùÔ∏è"],["our","üë®‚Äçüë©‚Äçüëß"],["over","üåà"],["page","üìÑ"],["picture","üñºÔ∏è"],
      ["place","üìç"],["play","‚öΩ"],["point","üëÜ"],["put","üì•"],["read","üìñ"],
      ["red","‚ù§Ô∏è"],["right","‚úÖ"],["run","üèÉ"],["same","üëØ"],["say","üí¨"],
      ["set","üì¶"],["should","üí≠"],["show","üé™"],["small","üêÅ"],["sound","üîä"],
      ["spell","‚ú®"],["still","üßò"],["study","üìö"],["such","üí´"],["take","ü§≤"],
      ["tell","üó£Ô∏è"],["thank","üôè"],["thin","üìè"],["thing","üì¶"],["think","ü§î"],
      ["three","3Ô∏è‚É£"],["through","üö™"],["too","‚ûï"],["try","üí™"],["turn","üîÑ"],
      ["us","üë´"],["very","‚≠ê"],["want","üôè"],["well","üíß"],["went","üö∂"],
      ["where","üó∫Ô∏è"],["why","‚ùì"],["work","üíº"],["world","üåç"],["years","üìÖ"]
    ]
  },
  grade2: {
    name: "Grade 2",
    btnClass: "g2",
    themeClass: "theme-g2",
    words: [
      ["above","‚¨ÜÔ∏è"],["add","‚ûï"],["almost","üéØ"],["along","üõ§Ô∏è"],["always","‚ôæÔ∏è"],
      ["ate","üçΩÔ∏è"],["began","üèÅ"],["begin","‚ñ∂Ô∏è"],["being","üåü"],["below","‚¨áÔ∏è"],
      ["between","‚ÜîÔ∏è"],["book","üìö"],["both","‚úåÔ∏è"],["brother","üë¶"],["busy","üèÉ"],
      ["buy","üõí"],["call","üìû"],["carry","üèãÔ∏è"],["city","üèôÔ∏è"],["clean","‚ú®"],
      ["close","üö™"],["country","üè°"],["cut","‚úÇÔ∏è"],["dog","üê∂"],["early","üåÖ"],
      ["earth","üåç"],["eat","üç¥"],["eight","8Ô∏è‚É£"],["enough","‚úã"],["every","üåü"],
      ["example","üìã"],["eyes","üëÄ"],["face","üòä"],["family","üë®‚Äçüë©‚Äçüëß‚Äçüë¶"],["far","üî≠"],
      ["father","üë®"],["feet","ü¶∂"],["few","ü§è"],["food","üçï"],["four","4Ô∏è‚É£"],
      ["friend","ü§ó"],["goodbye","üëã"],["got","üéâ"],["group","üë•"],["grow","üå±"],
      ["hard","üíé"],["head","üó£Ô∏è"],["hear","üëÇ"],["high","‚¨ÜÔ∏è"],["idea","üí°"],
      ["important","‚≠ê"],["it's","üëâ"],["keep","üîí"],["kitty","üê±"],["last","üèÅ"],
      ["late","‚è∞"],["leave","üö™"],["left","‚¨ÖÔ∏è"],["let","üëê"],["life","üå±"],
      ["light","üí°"],["list","üìù"],["love","‚ù§Ô∏è"],["might","üí™"],["mile","üõ§Ô∏è"],
      ["milk","ü•õ"],["miss","üò¢"],["mother","üë©"],["mountains","‚õ∞Ô∏è"],["near","üìç"],
      ["never","üö´"],["next","‚è≠Ô∏è"],["night","üåô"],["often","üîÑ"],["once","‚òùÔ∏è"],
      ["open","üìñ"],["own","üè†"],["paper","üìÑ"],["plant","üåø"],["pull","üß≤"],
      ["push","üëê"],["rain","üåßÔ∏è"],["real","‚úÖ"],["ride","üö≤"],["river","üèûÔ∏è"],
      ["saw","üëÅÔ∏è"],["school","üè´"],["sea","üåä"],["second","ü•à"],["seem","üëÄ"],
      ["sentence","üìù"],["seven","7Ô∏è‚É£"],["sheep","üêë"],["shoe","üëü"],["side","‚û°Ô∏è"],
      ["sister","üëß"],["snow","‚ùÑÔ∏è"],["something","üîÆ"],["sometimes","üïê"],["song","üéµ"],
      ["soon","‚è∞"],["start","‚ñ∂Ô∏è"],["state","üèõÔ∏è"],["stick","ü™µ"],["stop","üõë"],
      ["story","üìñ"],["talk","üó£Ô∏è"],["things","üì¶"],["those","üëâ"],["thought","üí≠"],
      ["together","ü§ù"],["took","ü§≤"],["tree","üå≥"],["under","‚¨áÔ∏è"],["until","‚è≥"],
      ["walk","üö∂"],["watch","‚åö"],["while","‚è≥"],["without","‚ùå"],["young","üë∂"]
    ]
  },
  grade3: {
    name: "Grade 3",
    btnClass: "g3",
    themeClass: "theme-g3",
    words: [
      ["across","‚ÜîÔ∏è"],["against","ü•ä"],["area","üìê"],["beautiful","üåπ"],["become","ü¶ã"],
      ["best","üèÜ"],["better","‚¨ÜÔ∏è"],["birthday","üéÇ"],["black","‚¨õ"],["body","üßç"],
      ["bottom","‚¨áÔ∏è"],["box","üì¶"],["certain","‚úÖ"],["children","üëß"],["cold","ü•∂"],
      ["color","üé®"],["complete","‚úÖ"],["couple","üë´"],["covered","üõ°Ô∏è"],["cried","üò¢"],
      ["didn't","üö´"],["door","üö™"],["draw","‚úèÔ∏è"],["during","‚è≥"],["easy","üòé"],
      ["ever","‚ôæÔ∏è"],["fall","üçÇ"],["farm","üöú"],["farmer","üë®‚Äçüåæ"],["fast","‚ö°"],
      ["field","üåæ"],["figure","üßÆ"],["fire","üî•"],["fish","üêü"],["five","5Ô∏è‚É£"],
      ["floor","üè†"],["funny","üòÇ"],["garden","üåª"],["ground","üåç"],["happened","üí•"],
      ["heard","üëÇ"],["herself","üë©"],["himself","üë®"],["hold","ü§≤"],["horse","üê¥"],
      ["hours","‚è∞"],["however","ü§î"],["hundred","üíØ"],["hurt","ü§ï"],["I'll","üôã"],
      ["king","üëë"],["knew","üß†"],["laugh","üòÇ"],["listen","üëÇ"],["low","‚¨áÔ∏è"],
      ["map","üó∫Ô∏è"],["mark","‚úèÔ∏è"],["measure","üìè"],["money","üí∞"],["morning","üåÖ"],
      ["music","üéµ"],["north","üß≠"],["notice","üëÄ"],["order","üìã"],["party","üéâ"],
      ["passed","‚úÖ"],["pattern","üî∑"],["piece","üß©"],["plan","üìã"],["please","üôè"],
      ["present","üéÅ"],["problem","ü§î"],["products","üì¶"],["pulled","üß≤"],["purple","üíú"],
      ["queen","üëë"],["questions","‚ùì"],["rabbit","üê∞"],["reached","ü§≤"],["remember","üß†"],
      ["rock","ü™®"],["room","üè†"],["seed","üå±"],["seen","üëÅÔ∏è"],["several","üî¢"],
      ["sharp","üî™"],["ship","üö¢"],["short","üìè"],["since","‚è∞"],["sing","üé§"],
      ["slow","üê¢"],["south","üß≠"],["space","üöÄ"],["stand","üßç"],["step","üë£"],
      ["sun","‚òÄÔ∏è"],["sure","‚úÖ"],["table","ü™ë"],["tiny","üêú"],["today","üìÖ"],
      ["told","üí¨"],["top","‚¨ÜÔ∏è"],["toward","‚û°Ô∏è"],["town","üèòÔ∏è"],["toy","üß∏"],
      ["travel","‚úàÔ∏è"],["true","‚úÖ"],["unit","üìè"],["upon","‚¨ÜÔ∏è"],["usually","üîÑ"],
      ["voice","üó£Ô∏è"],["vowel","üî§"],["war","‚öîÔ∏è"],["wash","üßº"],["waves","üåä"],
      ["white","‚¨ú"],["whole","‚≠ï"],["wind","üí®"],["window","ü™ü"],["wood","ü™µ"]
    ]
  },
  grade4: {
    name: "Grade 4",
    btnClass: "g4",
    themeClass: "theme-g4",
    words: [
      ["able","üí™"],["ago","‚è™"],["allow","‚úÖ"],["among","üë•"],["appear","üëÄ"],
      ["ball","‚öΩ"],["base","üè†"],["became","ü¶ã"],["behind","üîô"],["boat","‚õµ"],
      ["bread","üçû"],["bring","ü§≤"],["brought","üì¶"],["building","üè¢"],["built","üèóÔ∏è"],
      ["cannot","üö´"],["carefully","üßê"],["chair","ü™ë"],["check","‚úÖ"],["chicken","üêî"],
      ["circle","‚≠ï"],["class","üè´"],["clear","üíé"],["climb","üßó"],["common","ü§ù"],
      ["contain","üì¶"],["correct","‚úÖ"],["course","üõ§Ô∏è"],["dark","üåë"],["decided","ü§î"],
      ["deep","üåä"],["done","‚úÖ"],["dry","üèúÔ∏è"],["east","üß≠"],["equation","‚ûï"],
      ["explain","üí¨"],["fact","üìã"],["feel","üíù"],["filled","üè∫"],["finally","üèÅ"],
      ["fine","üëå"],["fly","‚úàÔ∏è"],["force","üí™"],["front","‚ñ∂Ô∏è"],["full","ü´ô"],
      ["game","üéÆ"],["gave","üéÅ"],["government","üèõÔ∏è"],["green","üíö"],["half","¬Ω"],
      ["heat","üî•"],["heavy","üèãÔ∏è"],["hot","üå°Ô∏è"],["inches","üìè"],["include","‚ûï"],
      ["inside","üì•"],["island","üèùÔ∏è"],["known","üß†"],["language","üó£Ô∏è"],["less","‚ûñ"],
      ["machine","‚öôÔ∏è"],["material","üß±"],["minutes","‚è±Ô∏è"],["myself","üôã"],["note","üìù"],
      ["nothing","üï≥Ô∏è"],["noun","üìù"],["object","üì¶"],["ocean","üåä"],["oh","üòÆ"],
      ["pair","üëØ"],["period","‚èπÔ∏è"],["person","üßë"],["plane","‚úàÔ∏è"],["power","‚ö°"],
      ["pretty","üå∏"],["produce","ü•¨"],["product","üì¶"],["quickly","‚ö°"],["ran","üèÉ"],
      ["rest","üò¥"],["road","üõ£Ô∏è"],["robin","üê¶"],["round","‚≠ï"],["rule","üìè"],
      ["scientists","üî¨"],["shall","üëÜ"],["shape","üî∑"],["shown","üëÄ"],["sign","ü™ß"],
      ["six","6Ô∏è‚É£"],["size","üìê"],["sky","üå§Ô∏è"],["special","‚≠ê"],["squirrel","üêøÔ∏è"],
      ["stars","‚≠ê"],["stay","üè†"],["stood","üßç"],["street","üõ£Ô∏è"],["strong","üí™"],
      ["surface","üîù"],["system","‚öôÔ∏è"],["teacher","üë©‚Äçüè´"],["ten","üîü"],["though","ü§î"],
      ["thousand","üî¢"],["understand","üß†"],["verb","üìù"],["wait","‚è≥"],["warm","‚òÄÔ∏è"],
      ["weak","üòì"],["weather","üå§Ô∏è"],["week","üìÖ"],["wheels","üõû"],["wish","‚≠ê"],
      ["within","üì•"],["women","üë©"],["year","üìÖ"],["yes","‚úÖ"],["yet","‚è≥"]
    ]
  }
};

// ===================== GAME STATE =====================
let game = {
  screen: 'welcome',
  gradeKey: null,
  batch: [],
  questionIndex: 0,
  score: 0,
  options: [],
  answered: false,
  selectedAnswer: null,
  correctOnFirst: [],
  totalCorrectFirst: 0
};

// ===================== AUDIO =====================
let audioCtx = null;
function getAudioCtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return audioCtx;
}

function playTone(freq, duration, type='sine', volume=0.15) {
  try {
    const ctx = getAudioCtx();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, ctx.currentTime);
    gain.gain.setValueAtTime(volume, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration);
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.start();
    osc.stop(ctx.currentTime + duration);
  } catch(e) {}
}

function playCorrectSound() {
  playTone(523, 0.12, 'sine', 0.15);
  setTimeout(() => playTone(659, 0.12, 'sine', 0.15), 100);
  setTimeout(() => playTone(784, 0.15, 'sine', 0.15), 200);
  setTimeout(() => playTone(1047, 0.3, 'sine', 0.12), 300);
}

function playWrongSound() {
  playTone(300, 0.15, 'sine', 0.1);
  setTimeout(() => playTone(250, 0.25, 'sine', 0.1), 120);
}

function playCelebration() {
  const notes = [523, 659, 784, 1047, 784, 1047, 1319];
  notes.forEach((n, i) => {
    setTimeout(() => playTone(n, 0.2, 'sine', 0.12), i * 120);
  });
}

// ElevenLabs TTS with caching + browser fallback
const audioCache = {};
const ELEVEN_VOICE_ID = '21m00Tcm4TlvDq8ikWAM'; // "Rachel" - warm, clear, kid-friendly

function getElevenLabsKey() {
  return localStorage.getItem('wordadventure_11labs_key') || '';
}
function setElevenLabsKey(key) {
  localStorage.setItem('wordadventure_11labs_key', key.trim());
}

async function speak(text) {
  const apiKey = getElevenLabsKey();
  if (!apiKey) {
    // Fallback to browser speech
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.rate = 0.85;
    u.pitch = 1.1;
    u.volume = 1;
    // Try to pick a good voice
    const voices = window.speechSynthesis.getVoices();
    const preferred = voices.find(v => /samantha|karen|google.*us/i.test(v.name));
    if (preferred) u.voice = preferred;
    window.speechSynthesis.speak(u);
    return;
  }

  const cacheKey = text.toLowerCase().trim();

  // Play from cache if available
  if (audioCache[cacheKey]) {
    const audio = audioCache[cacheKey].cloneNode();
    audio.play().catch(() => {});
    return;
  }

  // Fetch from ElevenLabs
  try {
    const resp = await fetch(
      `https://api.elevenlabs.io/v1/text-to-speech/${ELEVEN_VOICE_ID}`,
      {
        method: 'POST',
        headers: {
          'xi-api-key': apiKey,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          text: text,
          model_id: 'eleven_turbo_v2',
          voice_settings: {
            stability: 0.75,
            similarity_boost: 0.75,
            style: 0.4
          }
        })
      }
    );
    if (!resp.ok) throw new Error('API error');
    const blob = await resp.blob();
    const url = URL.createObjectURL(blob);
    const audio = new Audio(url);
    audioCache[cacheKey] = audio;
    audio.play().catch(() => {});
  } catch (e) {
    // Fallback to browser speech on error
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.rate = 0.85;
    u.pitch = 1.1;
    window.speechSynthesis.speak(u);
  }
}

// Pre-warm browser voices
window.speechSynthesis.getVoices();

// ===================== CONFETTI =====================
const confettiCanvas = document.getElementById('confetti-canvas');
const confettiCtx = confettiCanvas.getContext('2d');
let confettiParticles = [];
let confettiAnimId = null;

function resizeConfetti() {
  confettiCanvas.width = window.innerWidth;
  confettiCanvas.height = window.innerHeight;
}
window.addEventListener('resize', resizeConfetti);
resizeConfetti();

function launchConfetti(count=60) {
  const colors = ['#e74c3c','#f39c12','#2ecc71','#3498db','#9b59b6','#e91e63','#00bcd4','#ff9800'];
  for (let i = 0; i < count; i++) {
    confettiParticles.push({
      x: Math.random() * confettiCanvas.width,
      y: -20 - Math.random() * 100,
      w: 8 + Math.random() * 8,
      h: 6 + Math.random() * 6,
      color: colors[Math.floor(Math.random() * colors.length)],
      vx: (Math.random() - 0.5) * 4,
      vy: 2 + Math.random() * 4,
      rot: Math.random() * 360,
      rotV: (Math.random() - 0.5) * 10,
      life: 1
    });
  }
  if (!confettiAnimId) animateConfetti();
}

function animateConfetti() {
  confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
  confettiParticles.forEach(p => {
    p.x += p.vx;
    p.y += p.vy;
    p.vy += 0.1;
    p.rot += p.rotV;
    p.life -= 0.005;
    confettiCtx.save();
    confettiCtx.translate(p.x, p.y);
    confettiCtx.rotate(p.rot * Math.PI / 180);
    confettiCtx.globalAlpha = Math.max(0, p.life);
    confettiCtx.fillStyle = p.color;
    confettiCtx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
    confettiCtx.restore();
  });
  confettiParticles = confettiParticles.filter(p => p.life > 0 && p.y < confettiCanvas.height + 50);
  if (confettiParticles.length > 0) {
    confettiAnimId = requestAnimationFrame(animateConfetti);
  } else {
    confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
    confettiAnimId = null;
  }
}

// ===================== GAME LOGIC =====================
function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function startGame(gradeKey) {
  const gradeData = GRADES[gradeKey];
  const shuffled = shuffle(gradeData.words);
  const batch = shuffled.slice(0, 10);

  game = {
    screen: 'quiz',
    gradeKey,
    batch,
    questionIndex: 0,
    score: 0,
    options: [],
    answered: false,
    selectedAnswer: null,
    correctOnFirst: new Array(10).fill(false),
    totalCorrectFirst: 0
  };

  setupQuestion();
  document.body.className = gradeData.themeClass;
  render();

  setTimeout(() => {
    const [word] = game.batch[0];
    speak(word);
  }, 600);
}

function setupQuestion() {
  const gradeData = GRADES[game.gradeKey];
  const target = game.batch[game.questionIndex];
  const others = gradeData.words.filter(w => w[0] !== target[0]);
  const distractors = shuffle(others).slice(0, 3);
  game.options = shuffle([target, ...distractors]);
  game.answered = false;
  game.selectedAnswer = null;
  game.hadWrongAttempt = false;
}

function checkAnswer(idx) {
  if (game.answered) return;

  const selected = game.options[idx];
  const target = game.batch[game.questionIndex];
  const isCorrect = selected[0] === target[0];

  game.selectedAnswer = idx;

  if (isCorrect) {
    game.answered = true;
    if (!game.hadWrongAttempt) {
      game.score += 10;
      game.correctOnFirst[game.questionIndex] = true;
      game.totalCorrectFirst++;
    }
    playCorrectSound();
    launchConfetti(40);
    speak(target[0], 1);
    render();
    setTimeout(() => nextQuestion(), 1800);
  } else {
    game.hadWrongAttempt = true;
    playWrongSound();
    render();
    // Mark the wrong button, then reset after a moment
    setTimeout(() => {
      game.selectedAnswer = null;
      render();
    }, 800);
  }
}

function nextQuestion() {
  game.questionIndex++;
  if (game.questionIndex >= 10) {
    game.screen = 'results';
    playCelebration();
    launchConfetti(120);
    render();
    setTimeout(() => speak(getResultsMessage(), 0.9), 500);
  } else {
    setupQuestion();
    render();
    setTimeout(() => {
      const [word] = game.batch[game.questionIndex];
      speak(word);
    }, 400);
  }
}

function getResultsMessage() {
  const pct = game.totalCorrectFirst / 10;
  if (pct === 1) return "Perfect score! You are a superstar!";
  if (pct >= 0.8) return "Amazing job! You are so smart!";
  if (pct >= 0.6) return "Great work! Keep practicing!";
  return "Good try! Let's practice more!";
}

function openSettings() {
  const key = getElevenLabsKey();
  const hasKey = key.length > 0;
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.innerHTML = `
    <div class="modal">
      <h3>üîß Voice Settings</h3>
      <label for="api-key-input">ElevenLabs API Key</label>
      <input type="password" id="api-key-input" placeholder="Paste your API key here..." value="${key}" />
      <div class="hint">Get a free key at <strong>elevenlabs.io</strong> ‚Üí Profile ‚Üí API Keys.<br>Free tier gives ~10,000 characters/month.</div>
      <div class="api-status ${hasKey ? 'connected' : 'none'}">
        ${hasKey ? '‚úÖ API key is set ‚Äî using ElevenLabs voices' : 'üîä No key ‚Äî using browser voices (still works!)'}
      </div>
      <div class="modal-buttons">
        <button class="btn-cancel" onclick="closeSettings()">Cancel</button>
        <button class="btn-save" onclick="saveSettings()">Save</button>
      </div>
    </div>`;
  document.body.appendChild(overlay);
  overlay.querySelector('input').focus();
}

function closeSettings() {
  const overlay = document.querySelector('.modal-overlay');
  if (overlay) overlay.remove();
}

function saveSettings() {
  const input = document.getElementById('api-key-input');
  setElevenLabsKey(input.value);
  // Clear audio cache when key changes
  Object.keys(audioCache).forEach(k => delete audioCache[k]);
  closeSettings();
}

function goHome() {
  game.screen = 'welcome';
  document.body.className = '';
  render();
}

function replayGrade() {
  startGame(game.gradeKey);
}

function speakCurrentWord() {
  if (game.screen === 'quiz' && game.questionIndex < 10) {
    const [word] = game.batch[game.questionIndex];
    speak(word);
  }
}

// ===================== RENDERING =====================
function render() {
  const app = document.getElementById('app');

  if (game.screen === 'welcome') {
    app.innerHTML = renderWelcome();
  } else if (game.screen === 'quiz') {
    app.innerHTML = renderQuiz();
  } else if (game.screen === 'results') {
    app.innerHTML = renderResults();
  }
}

function renderWelcome() {
  let gradeButtons = '';
  for (const [key, g] of Object.entries(GRADES)) {
    gradeButtons += `
      <button class="grade-btn ${g.btnClass}" onclick="startGame('${key}')">
        ${g.name}
        <span class="word-count">(${g.words.length} words)</span>
      </button>`;
  }

  const hasKey = getElevenLabsKey().length > 0;
  return `
    <div class="welcome">
      <button class="settings-btn" onclick="openSettings()" title="Voice Settings">‚öôÔ∏è</button>
      <span class="mascot">ü¶â</span>
      <h1>Word Adventure!</h1>
      <p class="subtitle">Choose your level to start!</p>
      <div class="grade-grid">
        ${gradeButtons}
      </div>
      <div style="margin-top:18px;font-size:.85rem;opacity:.6">
        üîä Voice: ${hasKey ? 'ElevenLabs AI' : 'Browser (tap ‚öôÔ∏è for better voices)'}
      </div>
    </div>`;
}

function renderQuiz() {
  const target = game.batch[game.questionIndex];
  const [word, emoji] = target;
  const progress = ((game.questionIndex + (game.answered ? 1 : 0)) / 10) * 100;

  let optionButtons = '';
  game.options.forEach(([w, e], idx) => {
    let cls = 'option-btn';
    if (game.answered && w === word) {
      cls += ' correct';
    } else if (game.selectedAnswer === idx && w !== word) {
      cls += ' wrong';
    }
    if (game.answered) cls += ' disabled';

    optionButtons += `<button class="${cls}" onclick="checkAnswer(${idx})">${w}</button>`;
  });

  let feedback = '';
  if (game.answered) {
    feedback = `<div class="feedback correct-fb">üéâ That's right! <strong>${word}</strong> ${emoji}</div>`;
  } else if (game.selectedAnswer !== null) {
    feedback = `<div class="feedback wrong-fb">Not quite ‚Äî try again! üí™</div>`;
  }

  return `
    <div class="quiz">
      <div class="quiz-header">
        <div class="score-display">‚≠ê <span class="pts">${game.score}</span></div>
        <div class="progress-display">${game.questionIndex + 1} / 10</div>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" style="width:${progress}%"></div>
      </div>
      <div class="emoji-area">
        <span class="emoji-big">${emoji}</span>
        <button class="speaker-btn" onclick="speakCurrentWord()" title="Hear the word">üîä</button>
      </div>
      <div class="options-grid">
        ${optionButtons}
      </div>
      ${feedback}
    </div>`;
}

function renderResults() {
  const pct = game.totalCorrectFirst / 10;
  let starCount = 1;
  if (pct >= 0.6) starCount = 2;
  if (pct >= 0.9) starCount = 3;

  let stars = '';
  for (let i = 0; i < 3; i++) {
    stars += `<span class="star-anim">${i < starCount ? '‚≠ê' : '‚òÜ'}</span>`;
  }

  let reviewCards = '';
  game.batch.forEach(([word, emoji], i) => {
    const ok = game.correctOnFirst[i];
    reviewCards += `
      <div class="review-card ${ok ? '' : 'missed'}">
        <span class="r-emoji">${emoji}</span>
        <span class="r-word">${word}</span>
        <span class="r-check">${ok ? '‚úÖ' : 'üîÑ'}</span>
      </div>`;
  });

  return `
    <div class="results">
      <h2>üéâ All Done!</h2>
      <div class="stars-area">${stars}</div>
      <div class="score-final">
        You scored <strong>${game.score}</strong> out of 100!<br>
        <span style="font-size:.9em;opacity:.8">${game.totalCorrectFirst}/10 correct on first try</span>
      </div>
      <div class="review-section">
        <h3>üìñ Your Words</h3>
        <div class="review-grid">${reviewCards}</div>
      </div>
      <div class="results-buttons">
        <button class="btn-replay" onclick="replayGrade()">üîÑ Play Again</button>
        <button class="btn-home" onclick="goHome()">üè† Choose Level</button>
      </div>
    </div>`;
}

// ===================== INIT =====================
render();
</script>
</body>
</html>